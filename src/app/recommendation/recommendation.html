<div class="content-wrapper">

  <!-- Result Popup -->
  <div *ngIf="guessResult() === 'correct'" class="result-popup-backdrop" (click)="closePopup()">
    <div class="result-popup-content correct" (click)="$event.stopPropagation()">
      <h2>Congratulations! ðŸŽ‰</h2>
      <p>You guessed the correct manga!</p>
      <p>The answer was: <strong>{{ randomManga()?.title }}</strong></p>
      <button class="popup-close-button correct" (click)="closePopup()">Play Again Tomorrow</button>
    </div>
  </div>

  <!-- Incorrect Guess Popup -->
  <div *ngIf="guessResult() === 'incorrect'" class="result-popup-backdrop" (click)="closePopup()">
    <div class="result-popup-content incorrect" (click)="$event.stopPropagation()">
      <h2>Incorrect! ðŸ¤”</h2>
      <p>The correct manga is <strong>{{ randomManga()?.title }}</strong>!</p>
      <button class="popup-close-button incorrect" (click)="closePopup()">Try Again Tomorrow</button>
    </div>
  </div>

  <h1 class="title">Guess by the Manga Recommendations</h1>

  <div *ngIf="isLoading()" class="loading-container">
    <p>Loading recommendations...</p>
  </div>

  <ng-container *ngIf="!isLoading()">
    <div *ngIf="isBlurredHintVisible()" class="blurred-hint-container" (contextmenu)="$event.preventDefault()">
      <img [src]="randomManga()?.imageUrl" [alt]="randomManga()?.title" class="blurred-hint-image" draggable="false">
    </div>

    <div class="manga-panel-wrapper">
      <div *ngIf="areImagesLoading()" class="image-loading-overlay">
        <p>Loading recommendations...</p>
      </div>
      <div class="recommendation-panels-container">
        @for (rec of recommendations(); track rec.title) {
          <div class="recommendation-item">
            <div class="manga-panel-container">
              <img 
                [src]="rec.imageUrl" 
                [alt]="rec.title" 
                class="manga-panel-image">
              <div class="synopsis-overlay">
                <p class="synopsis-text">{{ rec.synopsis }}</p>
              </div>
            </div>
            <h3 class="panel-title">{{ rec.title }}</h3>
          </div>
        }
      </div>
    </div>
  
    <div *ngIf="isGameWon()" class="base-manga-title-container">
      Recommendations based on: <strong>{{ randomManga()?.title }}</strong>
    </div>

    <div *ngIf="isGameLost()" class="base-manga-title-container incorrect">
      The correct answer was: <strong>{{ randomManga()?.title }}</strong>
    </div>

    <div *ngIf="isGenreHintVisible()" class="genre-theme-hint-container">
      <p><strong>Genres:</strong> {{ randomManga()?.base_genres }}</p>
      <p><strong>Themes:</strong> {{ randomManga()?.base_themes }}</p>
    </div>

    <div class="hint-buttons-container">
      <button *ngIf="!isGenreHintVisible()" class="recommendation-hint-button" (click)="showGenreHint()">Genres & Themes</button>
      <button *ngIf="!isBlurredHintVisible()" class="recommendation-hint-button" (click)="showBlurredHint()" [disabled]="!isGenreHintVisible()">
        <span *ngIf="!isGenreHintVisible()">ðŸ”’ </span>Blurred Cover
      </button>
    </div>

    <!-- The main searchable dropdown component -->
    <div class="search-wrapper">
        <div class="search-dropdown-container">
          <!-- 1. Search Input and Button -->
          <div class="search-bar">
            <div class="input-wrapper">
              <input
                type="text"
                placeholder="Type to search items..."
                [ngModel]="searchTerm()"
                (ngModelChange)="searchTerm.set($event); isDropdownOpen.set(true)"
                (focus)="onInputFocus()"
                (blur)="onInputBlur()"
                [disabled]="isGameWon() || isGameLost()"
                class="search-input"
              >
              <button *ngIf="searchTerm() && !isGameWon() && !isGameLost()" (click)="clearSearch()" class="clear-button" type="button">&times;</button>
            </div>
            <button class="submit-button" (click)="checkGuess()" [disabled]="isSubmitting() || isGameWon() || isGameLost()" [class.correct-guess]="isGameWon()" [class.incorrect-guess]="isGameLost()">
              Guess
            </button>
          </div>
      
          <!-- 2. Dropdown List (Custom Options Overlay) -->
          <div *ngIf="isDropdownOpen()" class="dropdown-list">
            <!-- No Results Message -->
            <div *ngIf="filteredItemList().length === 0" class="no-results-option">
              No results found for "{{ searchTerm() }}"
            </div>
      
            <!-- Options Loop -->
            @for (item of filteredItemList(); track item.title) {
              <div class="dropdown-option" (mousedown)="selectItem(item)" [class.selected]="item.title === selectedItem()?.title">
                <div class="option-details">
                  <span class="option-name">{{ item.title }}</span>
                </div>
              </div>
            }
          </div>
        </div>
    </div>
  </ng-container>
</div>