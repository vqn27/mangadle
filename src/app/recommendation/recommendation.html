<div class="content-wrapper">

  <!-- Result Popup -->
  @if (guessResult(); as result) {
    <div class="result-popup-backdrop" (click)="closePopup()">
      <div class="result-popup-content" [class.correct]="result === 'correct'" [class.incorrect]="result === 'incorrect'" (click)="$event.stopPropagation()">
        @if (result === 'correct') {
          <h2>Congratulations! ðŸŽ‰</h2>
          <p>You guessed the correct manga!</p>
          <p>The answer was: <strong>{{ randomManga()?.title }}</strong></p>
          <button class="popup-close-button correct" (click)="closePopup()">Play Again Tomorrow</button>
        } @else {
          <h2>Incorrect! ðŸ¤”</h2>
          <p>The correct manga is <strong>{{ randomManga()?.title }}</strong>!</p>
          <button class="popup-close-button incorrect" (click)="closePopup()">Try Again Tomorrow</button>
        }
      </div>
    </div>
  }

  <h1 class="title">Guess by the Manga Recommendations</h1>

  <div class="date-navigator">
    <button class="nav-arrow" (click)="navigateToDay(-1)" [disabled]="isFirstDay()">&#9664;</button>
    <button class="game-date-text" (click)="navigateToHistory()">{{ gameDateText() }}</button>
    <button class="nav-arrow" (click)="navigateToDay(1)" [disabled]="isLastDay()">&#9654;</button>
  </div>

  <!-- Moved Blurred Cover Hint Button -->
  <div class="hint-buttons-container single-hint">
    <button 
      class="recommendation-hint-button" 
      (mouseenter)="onHintMouseEnter()" 
      (mouseleave)="onHintMouseLeave()"
      (mousemove)="onHintMouseMove($event)"
      [disabled]="!isGenreHintVisible()">
      @if (!isGenreHintVisible()) { <span>ðŸ”’ </span> }Blurred Cover
    </button>
  </div>


  <!-- Floating Blurred Image Hint -->
  @if (isBlurredHintActive()) {
    <div class="floating-blurred-hint" [style.left.px]="hintPositionX()" [style.top.px]="hintPositionY()">
      <img 
        [src]="randomManga()?.imageUrl" 
        [alt]="randomManga()?.title" 
        class="blurred-hint-image"
        [class.no-blur]="isGameWon() || isGameLost()"
        draggable="false">
    </div>
  }

  @if (isLoading()) {
    <div class="loading-container">
      <p>Loading recommendations...</p>
    </div>
  } @else {
    @if (areImagesLoading()) {
      <div class="image-loading-overlay">
        <p>Loading recommendations...</p>
      </div>
    }
    <div class="recommendation-panels-container">
      @for (rec of recommendations(); track rec.title) {
        <div class="recommendation-item">
          <div class="manga-panel-container">
            <img 
              [src]="rec.imageUrl" 
              [alt]="rec.title" 
              class="manga-panel-image">
            <div class="synopsis-overlay">
              <p class="synopsis-text">{{ rec.synopsis }}</p>
            </div>
          </div>
          <h3 class="panel-title">{{ rec.title }}</h3>
        </div>
      }
    </div>
    
    @if (isGameWon() || isGameLost()) {
      <div class="answer-container"
           [class.correct-answer]="isGameWon()"
           [class.incorrect-answer]="isGameLost()">
        @if (isGameWon()) {
          <span>Recommendations based on: <strong>{{ randomManga()?.title }}</strong></span>
        } @else {
          <span>The correct answer was: <strong>{{ randomManga()?.title }}</strong></span>
        }
      </div>
    }
    @if (isGenreHintVisible()) {
      <div class="genre-theme-hint-container">
        <p><strong>Genres:</strong> {{ randomManga()?.base_genres }}</p>
        <p><strong>Themes:</strong> {{ randomManga()?.base_themes }}</p>
      </div>
    }

    <div class="hint-buttons-container">
      @if (!isGenreHintVisible()) { <button class="recommendation-hint-button" (click)="showGenreHint()">Genres & Themes</button> }
    </div>

    <!-- The main searchable dropdown component -->
    <div class="search-wrapper">
        <div class="search-dropdown-container">
          <!-- 1. Search Input and Button -->
          <div class="search-bar">
            <div class="input-wrapper">
              <input
                type="text"
                placeholder="Type to search items..."
                [ngModel]="searchTerm()"
                (ngModelChange)="searchTerm.set($event); isDropdownOpen.set(true)"
                (focus)="onInputFocus()"
                (blur)="onInputBlur()"
                [disabled]="isGameWon() || isGameLost()"
                class="search-input"
              >
              @if (searchTerm() && !isGameWon() && !isGameLost()) {
                <button (click)="clearSearch()" class="clear-button" type="button">&times;</button>
              }
            </div>
            <button class="submit-button" (click)="checkGuess()" [disabled]="isSubmitting() || isGameWon() || isGameLost()" [class.correct-guess]="isGameWon()" [class.incorrect-guess]="isGameLost()">
              Guess
            </button>
          </div>
      
          <!-- 2. Dropdown List (Custom Options Overlay) -->
          @if (isDropdownOpen()) {
            <div class="dropdown-list">
              @if (filteredItemList().length === 0) {
                <div class="no-results-option">No results found for "{{ searchTerm() }}"</div>
              } @else {
                @for (item of filteredItemList(); track item.title) {
                  <div class="dropdown-option" (mousedown)="selectItem(item)" [class.selected]="item.title === selectedItem()?.title">
                    <div class="option-details">
                      <span class="option-name">{{ item.title }}</span>
                    </div>
                  </div>
                }
              }
            </div>
          }
        </div>
    </div>
  }
</div>