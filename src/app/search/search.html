<div class="backdrop" *ngIf="isEnlarged()" (click)="isEnlarged.set(false)"></div>

<!-- Result Popup -->
<div *ngIf="guessResult() === 'correct'" class="result-popup-backdrop" (click)="closePopup()">
  <div class="result-popup-content correct" (click)="$event.stopPropagation()">
    <h2>Congratulations! ðŸŽ‰</h2>
    <p>You guessed the correct manga!</p>
    <p>These pages appear in chapter {{ randomDailyMangaChapter }}</p>
    <button class="popup-correct-button-close-button" (click)="closePopup()">Play Again Tomorrow</button>
  </div>
</div>

<!-- Incorrect Guess Popup -->
<div *ngIf="guessResult() === 'incorrect'" class="result-popup-backdrop" (click)="closePopup()">
  <div class="result-popup-content incorrect" (click)="$event.stopPropagation()">
    <h2>Incorrect! ðŸ¤”</h2>
    <p>The correct manga is {{ randomDailyManga()?.title }}!</p>
    <p>These pages appear in chapter {{ randomDailyMangaChapter}}</p>
    <button class="popup-incorrect-button-close-button" (click)="closePopup()">Play Again Tomorrow</button>
  </div>
</div>

<div class="content-wrapper">
  <h1 class="title">Guess the Manga Panel</h1>

  <div *ngIf="isLoading()" class="loading-container">
    <p>Loading game...</p>
  </div>

  <ng-container *ngIf="!isLoading()">
    <div class="manga-panel-wrapper">
      <div *ngIf="areImagesLoading()" class="image-loading-overlay">
        <p>Loading panels...</p>
      </div>
      <div class="manga-panel-container" [class.enlarged]="isEnlarged()" (click)="toggleEnlarged($event)">
        <img 
          [src]="currentPanelUrl()" 
          alt="Manga Panel to guess" 
          class="manga-panel-image"
        >
      </div>
    </div>

    <div *ngIf="isGameWon() || guessIncorrect()"
         class="answer-container"
         [class.correct-answer]="isGameWon()"
         [class.incorrect-answer]="guessIncorrect()">
      Manga: {{ randomDailyManga()?.title }}
    </div>
  
    <div class="panel-buttons-container">
       <button class="panel-button" (click)="showPanel(1)" [class.active]="currentPanelUrl() === panelImages[0]">1</button>
      <button class="panel-button" (click)="showPanel(2)" [disabled]="highestPanelRevealed() < 1" [class.active]="currentPanelUrl() === panelImages[1]">2</button>
      <button class="panel-button" (click)="showPanel(3)" [disabled]="highestPanelRevealed() < 2" [class.active]="currentPanelUrl() === panelImages[2]">
        <span *ngIf="highestPanelRevealed() < 2" class="lock-emoji">ðŸ”’ </span>3
      </button>
      <button *ngIf="!isHintRevealed()" class="panel-button hint-button" [disabled]="highestPanelRevealed() < 3" (click)="showHint()">
        <span *ngIf="highestPanelRevealed() < 3" class="lock-emoji">ðŸ”’ </span>Hint: Score & Popularity
      </button>
    </div>
  
    <div *ngIf="isHintRevealed() && randomDailyManga()" class="hint-text-container">
      <p>Score: {{ randomDailyManga()?.score }}</p>
      <p>Popularity: #{{ randomDailyManga()?.popularity }}</p>
    </div>
  
    <!-- The main searchable dropdown component -->
    <div class="search-wrapper">
        <div class="search-dropdown-container">
          <!-- 1. Search Input and Button -->
          <div class="search-bar">
            <div class="input-wrapper">
              <input
                type="text"
                placeholder="Type to search items..."
                [ngModel]="searchTerm()"
                (ngModelChange)="searchTerm.set($event); isDropdownOpen.set(true)"
                (focus)="onInputFocus()"
                (blur)="onInputBlur()"
                [disabled]="isGameWon() || guessIncorrect()"
                class="search-input"
              >
              <button *ngIf="searchTerm() && !isGameWon() && !guessIncorrect()" (click)="clearSearch()" class="clear-button" type="button">&times;</button>
            </div>
            <button class="submit-button" (click)="checkGuess()" [disabled]="isSubmitting() || isGameWon() || guessIncorrect()" [class.incorrect-guess]="guessIncorrect()" [class.correct-guess]="isGameWon()">
              Guess
            </button>
          </div>
      
          <!-- 2. Dropdown List (Custom Options Overlay) -->
          <div *ngIf="isDropdownOpen()" class="dropdown-list">
            <!-- No Results Message -->
            <div *ngIf="filteredItemList().length === 0" class="no-results-option">
              No results found for "{{ searchTerm() }}"
            </div>
      
            <!-- Options Loop -->
            @for (item of filteredItemList(); track item.title) {
              <div class="dropdown-option" (mousedown)="selectItem(item)" [class.selected]="item.title === selectedItem()?.title">
                <div class="option-details">
                  <span class="option-name">{{ item.title }}</span>
                </div>
              </div>
            }
          </div>
        </div>
    </div>
  </ng-container>
</div>
