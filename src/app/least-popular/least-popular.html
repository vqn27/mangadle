<div class="content-wrapper">

  <!-- Result Popup -->
  <div *ngIf="guessResult() === 'correct'" class="result-popup-backdrop" (click)="closePopup()">
    <div class="result-popup-content correct" (click)="$event.stopPropagation()">
      <h2>Congratulations! üéâ</h2>
      <p>You guessed the correct manga!</p>
      <p>The answer was: <strong>{{ dailyData()?.baseTitle }}</strong></p>
      <button class="popup-close-button correct" (click)="closePopup()">Play Again Tomorrow</button>
    </div>
  </div>

  <!-- Incorrect Guess Popup -->
  <div *ngIf="guessResult() === 'incorrect'" class="result-popup-backdrop" (click)="closePopup()">
    <div class="result-popup-content incorrect" (click)="$event.stopPropagation()">
      <h2>Incorrect! ü§î</h2>
      <p>The correct manga is <strong>{{ dailyData()?.baseTitle }}</strong>!</p>
      <button class="popup-close-button incorrect" (click)="closePopup()">Try Again Tomorrow</button>
    </div>
  </div>

  <h1 class="title">Guess by the Least Popular Characters</h1>

  <div *ngIf="isLoading()" class="loading-container">
    <p>Loading characters...</p>
  </div>

  <ng-container *ngIf="!isLoading()">
    <div class="character-panels-container">
      @for (char of dailyData()?.characters; track char.id; let i = $index) {
        <div class="character-card">
          <div class="character-image-container">
            <img [src]="char.imageUrl" [alt]="char.name" class="character-image" [class.blur]="i > 0 && !unblurredStates()[i]" (contextmenu)="$event.preventDefault()" draggable="false">
          </div>
          <div class="character-details">
            <h3 class="character-name" [class.blur-text]="i > 0 && !unblurredStates()[i]">{{ char.name }}</h3>
            <p class="character-favorites">
              <span class="heart-icon">Favorite: ‚ù§Ô∏è</span> {{ char.favorites.toLocaleString() }}
            </p>
          </div>
          @if (i > 0) {
            <button class="unblur-button" (click)="unblurImage(i)" [disabled]="unblurredStates()[i] || (i > 1 && !unblurredStates()[i-1])">
              @if (i > 1 && !unblurredStates()[i-1]) {
                <span>üîí </span>
              }
              Unblur
            </button>
          }
        </div>
      }
    </div>

    <div *ngIf="isGameWon() || isGameLost()"
         class="answer-container"
         [class.correct-answer]="isGameWon()"
         [class.incorrect-answer]="isGameLost()">
      The correct answer was: {{ dailyData()?.baseTitle }}
    </div>

    <!-- The main searchable dropdown component -->
    <div class="search-wrapper">
        <div class="search-dropdown-container">
          <!-- 1. Search Input and Button -->
          <div class="search-bar">
            <div class="input-wrapper">
              <input
                type="text"
                placeholder="Type to search items..."
                [ngModel]="searchTerm()"
                (ngModelChange)="searchTerm.set($event); isDropdownOpen.set(true)"
                (focus)="onInputFocus()"
                (blur)="onInputBlur()"
                [disabled]="isGameWon() || isGameLost()"
                class="search-input"
              >
              <button *ngIf="searchTerm() && !isGameWon() && !isGameLost()" (click)="clearSearch()" class="clear-button" type="button">&times;</button>
            </div>
            <button class="submit-button" (click)="checkGuess()" [disabled]="isSubmitting() || isGameWon() || isGameLost()" [class.correct-guess]="isGameWon()" [class.incorrect-guess]="isGameLost()">
              Guess
            </button>
          </div>
      
          <!-- 2. Dropdown List (Custom Options Overlay) -->
          <div *ngIf="isDropdownOpen()" class="dropdown-list">
            <!-- No Results Message -->
            <div *ngIf="filteredItemList().length === 0" class="no-results-option">
              No results found for "{{ searchTerm() }}"
            </div>
      
            <!-- Options Loop -->
            @for (item of filteredItemList(); track item.title) {
              <div class="dropdown-option" (mousedown)="selectItem(item)" [class.selected]="item.title === selectedItem()?.title">
                <div class="option-details">
                  <span class="option-name">{{ item.title }}</span>
                </div>
              </div>
            }
          </div>
        </div>
    </div>
  </ng-container>
</div>